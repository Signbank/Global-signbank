{% extends "baselayout.html" %}
{% load i18n %}
{% load stylesheet %}
{% load bootstrap3 %}
{% load tagging_tags %}

{% load guardian_tags %}
{% load annotation_idgloss_translation %}

{% block bootstrap3_title %}
{% blocktrans %}Signbank: Map Keywords to Senses{% endblocktrans %}
{% endblock %}

{% block extrajs %}
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.jeditable.mini_colors.js"></script>
<link href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.0/css/select2.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.5/js/select2.full.js"></script>

<script type='text/javascript'>
var url = '{{ PREFIX_URL }}';
var saving_str = '{{saving_str|escapejs}}';
var csrf_token = '{{csrf_token}}';
var multiple_select_fields = {{MULTIPLE_SELECT_GLOSS_FIELDS|safe}};
</script>

<script type='text/javascript' src="{{ STATIC_URL }}js/senses_keywords_edit.js"></script>

<script type='text/javascript'>
$(document).ready(function() {

    function makeMultipleSelect(fieldId,fieldVar) {
        var target_pulldown = document.getElementById(fieldId);
        if (!target_pulldown) { return; }
        target_pulldown.setAttribute('multiple','multiple');
        target_pulldown.setAttribute('class',"js-example-basic-multiple form-control");
        target_pulldown.setAttribute('name',fieldVar);
        target_pulldown.style.width = '100%';
    }

     for (var i = 0; i < multiple_select_fields.length; i++) {
        var this_id = 'id_' + multiple_select_fields[i];
        var this_var = multiple_select_fields[i] + '[]';
        makeMultipleSelect(this_id, this_var);
     }

     $('.js-example-basic-multiple').each(function() {
         var thisId = this.id;
         $(this).select2({
            allowClear: true,
            dropdownAutoWidth: true,
            width: 'resolve',
            placeholder: '',
         });
     });

     $('.js-example-basic-multiple').val(null).trigger('change');
});
</script>

<script type='text/javascript'>

// http://www.javascript-coder.com/javascript-form/javascript-reset-form.phtml
function clearForm() {
     $('.js-example-basic-multiple').val(null).trigger('change');
}
</script>
{% endblock %}

{% block extrahead %}
<style>
.actions {
    color: white !important;
    background-color: white !important;
    -webkit-appearance: none;
    -moz-appearance: none;
}
.actionLabel {
    border: 1px solid;
    text-align: center;
    padding: 6px 12px;
    border-radius: 6px;
    background-color: white;
    margin: 0 0 0 0;
}
.actionLabel:hover {
    text-decoration: none;
}
.actionLabel:active:focus {
    text-decoration: none;
    outline: none;
}
.actionButton {
    padding: 0;
    border: 0px;
    border-width: 0px;
    margin: 0 0 0 0;
    border-radius: 6px;
    text-align: center;
}
.actionButton:hover {
    text-decoration: none;
}
.actionButton:active:focus {
    text-decoration: none;
    background-color: none;
    outline: none;
}
.tags-cell {
    overflow-y: visible;
    width: 255px;
    box-sizing: inherit;
    white-space: nowrap;
}
</style>
{% endblock %}

{% block content %}

<div id="definitionblock" style="padding-top: 30px;">
    {% if not object_list %}
    <br>
    {% trans "No senses found." %}

    {% else %}
    <div class="keywordsSenses" id="keywordsSenses">
    <h3>{% trans "Map Keywords to Senses" %}</h3>

        <div id='searchform_outer' class='well '>
        <form name='adminsearch' id='adminsearch' method='get' action='{{PREFIX_URL}}/dictionary/keywords/'>
        {% csrf_token %}
        <div class="panel panel-default">
            <div class="panel-heading" data-toggle="collapse" data-target="#query-area">{% trans "Construct Filter" %}
            </div>
                <div id='query-area' class='collapse {% if request.GET|length == 0 and not show_all %} in {% endif %}'>
                <div id='searchformwell' class='well search-results-collapsable'>

                <div class="hidden">
                    <input name='sortOrder' class='form-control' value='' >
                    <input name='search_type' class='form-control' value='filter'>
                </div>

                <div class="panel panel-default">
                  <div class="panel-heading" data-toggle="collapse"
                           data-target="#pub_search">{% trans "Search by Tags" %}</div>

                      <div id='pub_search' class='collapse'>
                      <table class='table table-condensed' style="width:65%;">
                      <tr>
                          <td style="padding-left:30px;"><label for='id_tags'>{% trans "Tags" %}</label></td>
                          <td style="width:600px;">{{searchform.tags}}</td>
                      </tr>
                      </table>
                      </div>
                    </div>
                </div>
        <div class='btn-toolbar' style="margin-bottom: 20px">
        <input class='btn btn-primary' type='submit' name="filter" value='Apply Filter'>
        <input class='btn btn-primary' type='reset' onclick="clearForm();"
                       value='{% trans "Reset" %}'>
        </div>
        </div>
        </div>

        </form>
        </div>

<div>
<table class='table table-condensed'>
    <thead>
      <tr>
          <th style="width:200px;">{% trans "Gloss" %}</th>
          <th style="width:300px;">{% trans "Actions" %}</th>
          <th style="width:300px;">{% trans "Keywords" %}</th>
          <th style="width:300px;">{% trans "Senses" %}</th>
          <th>{% trans "Quick Tag Toggle" %}</th>
          <th style="width:255px;">{% trans "Tags" %}</th>
      </tr>
    </thead>
    <tbody>
    {% for gloss, keywords_per_language, senses_per_language in page_obj %}
        <tr>
            <td><a href="{{PREFIX_URL}}/dictionary/gloss/{{gloss.pk}}">{{gloss|get_default_annotation_idgloss_translation}}</a></td>
            <td class="actions">
                <table>
                {% for language in dataset_languages %}
                <tr>
                <td>
                <div class='btn-toolbar' style="margin-bottom: 20px">
                <button id='edit_keywords_btn_{{gloss.id}}_{{language.id}}' type="button" class="btn actionButton"
                        name='edit_keywords_{{gloss.id}}' value='edit_keywords_{{gloss.id}}'
                        data-toggle='modal' data-target='#edit_keywords_modal_{{gloss.id}}_{{language.id}}'>
                    <a class="actionLabel">{% if perms.dictionary.change_gloss %}
                        {% trans "Edit" %}
                        {% else %}
                        {% trans "View" %}
                        {% endif %}
                        {{language.name}}</a></button>
                <button id='edit_senses_btn_{{gloss.id}}_{{language.id}}' type="button" class="btn actionButton"
                        name='edit_{{gloss.id}}' value='edit_{{gloss.id}}'
                        data-toggle='modal' data-target='#edit_senses_modal_{{gloss.id}}_{{language.id}}'>
                    <a class="actionLabel">{% if perms.dictionary.change_gloss %}
                        {% trans "Group Senses" %}
                        {% else %}
                        {% trans "View Senses" %}
                        {% endif %} {{language.name}}</a></button>
                {% endfor %}
                </div>
                </td>
                </tr>
                </table>
            </td>
            <td class="keywords_{{gloss.id}}">
                <table>
                {% for lang, keywords in keywords_per_language.items %}
                    <tr>
                    <td>{{lang.language_code_2char|upper}}</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
                    <td>
                        <table>
                        <tbody id="tbody_keywords_{{gloss.id}}_{{lang.id}}">
                        <tr><td>
                        {% for trn in keywords %}
                            {{ trn.translation.text|safe }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                        </td></tr>
                        </tbody>
                        </table>
                    </td>
                    </tr>
                {% endfor %}
                </table>
            </td>
            <td class="senses_{{gloss.id}}" id="senses_{{gloss.id}}">
                <table>
                {% for lang, senses in senses_per_language.items %}
                    <tr><td>{{lang.language_code_2char|upper}}</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
                        <td>
                        <table>
                            <tbody id="tbody_senses_{{gloss.id}}_{{lang.id}}">
                            {% for grp, kwds in senses.items %}
                                <tr id="senses_{{gloss.id}}_row_{{grp}}">
                                <td>{{grp}}.</td><td>&nbsp;&nbsp;</td>
                                <td>{% for kw in kwds %}
                                    {{ kw.translation.text|safe }}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        </td>
                    </tr>
                {% endfor %}
                </table>
            </td>
            <td>{% if perms.dictionary.change_gloss %}
                <button id='quick_tag_btn_{{gloss.id}}' class="quick_tag btn actionButton" name='quick_tag_{{gloss.id}}'
                        value='{{gloss.id}}' type="submit" ><a class="actionLabel">{% trans "Check Senses" %}</a>
                </button>
                {% endif %}
            </td>
            {% load underscore_to_space %}
            {% tags_for_object gloss as tag_list %}
            <td class="field_tags" style="width:255px;">
                <div class="tags-cell"
                     id="tags_cell_{{gloss.id}}">{% for tag in tag_list %}<span class='tag'>{{tag.name|underscore_to_space}}</span> {% endfor %}</div>
            </td>
        </tr>

        {% for language in dataset_languages %}
        <tr class="empty-row">
            <td colspan=6>
             <div class="modal fade" id="edit_senses_modal_{{gloss.id}}_{{language.id}}" tabindex="-1" role="dialog"
                 aria-labelledby="#modalTitleEdit_{{gloss.id}}_{{language.id}}" aria-hidden="true">
             <div class="modal-dialog modal-lg" id='modalTitleEdit_{{gloss.id}}_{{language.id}}'>
                <div class="modal-content">
                    <div class='modal-header'>
                        <h3>{% trans "Gloss Keywords Mapping to Senses" %} ({{language.name}})</h3>
                    </div>
                    <div class='modal-body'>
                        <table class="table table-condensed">
                            <thead>
                            <tr><th colspan=3>{{gloss|get_default_annotation_idgloss_translation}}</th></tr>
                            </thead>
                            <tbody id="tbody_modal_senses_{{gloss.id}}_{{language.id}}">
                            {% with senses_per_language|get_item:language as senses_groups %}
                            {% for order_index, keywords_list in senses_groups.items %}
                            <tr id="modal_senses_{{gloss.id}}_row_{{order_index}}">
                            <td>{{order_index}}.</td>
                            <td>
                              {% for sense in keywords_list %}
                                <span id="sensegroup_{{sense.orderIndex}}">
                                    {{sense.translation.text|safe}}
                                </span>{% if not forloop.last %}, {% endif %}
                              {% endfor %}
                            </td>
                            {% endfor %}
                            </tr>
                            {% endwith %}
                            </tbody>
                        </table>
                      <form id="form_regroup_keywords_{{gloss.id}}_{{language.id}}"
                            action="{% url 'dictionary:group_keywords' gloss.id %}" method='post'>
                      {% csrf_token %}
                      <table class='table table-condensed'>
                          <thead>
                            <tr><th>{% trans "Keywords" %}</th><th>{% trans "Sense" %}</th></tr>
                          </thead>
                          <tbody id="tbody_senses_table_{{gloss.id}}_{{language.id}}">
                          {% with keywords_per_language|get_item:language as keywords %}
                          {% for sense in keywords %}
                            <tr>
                                <td id="keyword_sense_index_{{gloss.id}}_{{language.id}}_{{forloop.counter}}">{{sense.translation.text}}</td>
                                <input type="hidden" id="sense_id_{{sense.id}}"
                                       name="group_index" value='{{sense.id}}' data-group_index='{{sense.id}}'>
                                <td>
                                <input type="number" id="regroup_{{sense.orderIndex}}"
                                       name="regroup" value='{{sense.orderIndex}}' data-regroup='{{sense.orderIndex}}'
                                       max={{senses.count}}>
                                </td>
                            </tr>
                          {% endfor %}
                          {% endwith %}
                          </tbody>
                      </table>
                          <input type="hidden" name="language" value="{{language.id}}">
                          {% if perms.dictionary.change_gloss %}
                          <button class="regroup_keywords btn btn-primary" id="regroup_keywords_{{gloss.id}}_{{language.id}}" value='{{gloss.id}}'
                                    data-language="{{language.id}}" type="submit">
                              {% trans "Regroup Kewords" %}</button>
                          {% endif %}
                      </form>
                       <br/>
                       <br/>
                       <h4>{% trans "Add Sense" %}</h4>
                       <form id='add_keyword_form_{{gloss.id}}_{{language.id}}'
                             method='post' action='{% url "dictionary:add_keyword" gloss.id %}'>
                           {% csrf_token %}
                           <table class='table table-condensed'>
                               <tr>
                                   <td>{% trans "Keywords" %}</td>
                                   <td>
                                       <input name='keyword' type="text"
                                              placeholder='{% trans "Text" %}' value="">
                                   </td>
                               </tr>
                           </table>
                          <input type="hidden" name="language" value="{{language.id}}">
                          {% if perms.dictionary.change_gloss %}
                          <button class="add_keyword btn btn-primary" id="add_keyword_{{gloss.id}}_{{language.id}}" value='{{gloss.id}}'
                                    data-language="{{language.id}}" type="submit">
                              {% trans "Add Sense" %}</button>
                          {% endif %}
                        </form>
                     </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Dismiss" %}</button>
                      </div>
                </div>
            </div>
        </div>

         <div class="modal fade" id="edit_keywords_modal_{{gloss.id}}_{{language.id}}" tabindex="-1" role="dialog"
                 aria-labelledby="#modalKeywordsTitleEdit_{{gloss.id}}_{{language.id}}" aria-hidden="true">
             <div class="modal-dialog modal-lg" id='modalKeywordsTitleEdit_{{gloss.id}}_{{language.id}}'>
                <div class="modal-content">
                    <div class='modal-header'>
                        <h3>
                            {% trans "Keywords" %} ({{language.name}})</h3>
                    </div>
                    <div class='modal-body'>
                        <table class="table table-condensed">
                            <thead>
                            <tr><th colspan=3>{{gloss|get_default_annotation_idgloss_translation}}</th></tr>
                            </thead>
                            <tbody id="tbody_modal_keywords_{{gloss.id}}_{{language.id}}">
                            {% with senses_per_language|get_item:language as senses_groups %}
                            {% for order_index, keywords_list in senses_groups.items %}
                            <tr id="modal_keywords_{{gloss.id}}_row_{{order_index}}">
                            <td>{{order_index}}.</td>
                            <td>
                              {% for sense in keywords_list %}
                                <span id="keywords_{{sense.orderIndex}}">
                                    {{sense.translation.text|safe}}
                                </span>{% if not forloop.last %}, {% endif %}
                              {% endfor %}
                            </td>
                            {% endfor %}
                            </tr>
                            {% endwith %}
                            </tbody>
                        </table>
                      <form id="form_edit_keywords_{{gloss.id}}_{{language.id}}"
                            action="{% url 'dictionary:edit_keywords' gloss.id %}" method='post'>
                      {% csrf_token %}
                      <table class='table table-condensed' id="edit_keywords_table_{{gloss.id}}_{{language.id}}">
                          {% with keywords_per_language|get_item:language as keywords %}
                          <tr><th>{% trans "Keywords" %}</th><th>{% trans "New Text" %}</th></tr>
                          {% for keyword in keywords %}
                        <tr id="edit_keywords_row_{{gloss.id}}_{{language.id}}_{{keyword.id}}">
                            <td>{{keyword.translation.text}}</td>
                            <input type="hidden" id="keyword_index_{{keyword.id}}"
                                   name="keyword_index" value='{{keyword.id}}' data-index='{{keyword.id}}'>
                            <td>
                            <input type="text" id="edit_keyword_text_{{keyword.id}}"
                                   name="translation" value='{{keyword.translation.text}}'
                                   data-translation='{{keyword.id}}'>
                            </td>
                        </tr>
                          {% endfor %}
                          {% endwith %}
                      </table>
                          <input type="hidden" name="language" value="{{language.id}}">
                          {% if perms.dictionary.change_gloss %}
                          <button class="edit_keywords btn btn-primary" id="edit_keywords_{{gloss.id}}_{{language.id}}" value='{{gloss.id}}'
                                    data-language="{{language.id}}" type="submit">
                              {% trans "Save Changes" %}</button>
                          {% endif %}
                      </form>
                     </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Dismiss" %}</button>
                      </div>
                </div>
            </div>
        </div>
        </td>
        </tr>
        {% endfor %}
    {% endfor %}
    </tbody>
</table>
</div>
</div>
{% endif %}
<div class="pagination">
    <span class="step-links">
        <ul class='pagination pagination-sm'>
        {% if page_obj.has_previous %}
            <li><a href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">&laquo;</a></li>
        {% endif %}

          {% if  page_obj.number > 10 %}
            <li><a>...</a></li>
          {% endif %}

          {% for p in page_obj.paginator.page_range %}

             {% if p < page_obj.number|add:"10" and  p > page_obj.number|add:"-10" %}
             <li {% if p == page_obj.number %}class='active'{% endif %}>
             <a href="?page={{ p }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{% if p == 0 %}Start{% else %}{{p}}{% endif %}</a>
             </li>
             {% endif %}

          {% endfor %}

          {% if page_obj.paginator.num_pages > page_obj.number|add:"10" %}
            <li><a>...</a></li>
            <li>
            <a href="?page={{ page_obj.paginator.num_pages }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{page_obj.paginator.num_pages}}</a>
            </li>
          {% endif %}

        {% if page_obj.has_next %}
            <li><a href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">&raquo;</a></li>

      </ul>
        {% endif %}
    </span>
</div>
</div>
{% endblock content %}

