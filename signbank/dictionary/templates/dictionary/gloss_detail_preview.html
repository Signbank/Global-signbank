{% extends 'baselayout.html' %}
{% load i18n %}
{% load stylesheet %}
{% load annotation_idgloss_translation %}
{% load bootstrap3 %}

{% block bootstrap3_title %}
{% blocktrans %}Sign for {{ gloss }} (Preview Colors){% endblocktrans %}
{% endblock %}

{% load guardian_tags %}



{% block extrajs %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery.jeditable.mini_colors.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery.jeditable.checkbox.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/typeahead.bundle.min.js"></script>

    <script type='text/javascript'>
    var url = '{{ PREFIX_URL }}';
    var phonology_list_kinds = {{phonology_list_kinds|safe}};
    var gloss_phonology = {{gloss_phonology|safe}};

    var language_code = '{{ LANGUAGE_CODE }}';
    var edit_mode_str = '{% trans "Edit" %}';
    var turn_off_edit_mode_str = '{% trans "Turn off edit mode" %}';
    var delete_this_gloss_str = '{% trans "Delete this gloss" %}';
    var saving_str = '{% trans "Saving..." %}';
    var idgloss_already_exists_str = '{% trans "This idgloss already exists" %}';
    var yes_str = '{% trans "Yes" %}'
    var no_str = '{% trans "No" %}'
    var original_strong_hand = '{{StrongHand}}';
    var original_weak_hand = '{{WeakHand}}';
    var original_lemma_group_url = '{{lemma_group_url}}';
    var lemma_group = '{{lemma_group}}';

    var edit_post_url = '{% url 'dictionary:update_gloss' gloss.id %}';
    var definition_role_choices = {{gloss.definition_role_choices_json|safe}};
    var relation_role_choices = {{gloss.relation_role_choices_json|safe}};
    var relation_delete_choices = '{ "delete" : "Delete" }';
    var relation_delete_choices_colors = '{ "delete" : "ffffff" }';
    var handedness_weak_choices = {{gloss.handedness_weak_drop_reverse_prop_json|safe}};
    var handedness_weak_choices_colors = '{}';
    for (var key in handedness_weak_choices) {
        //console.log('handedness_weak_choices: '+key+' '+handedness_weak_choices[key]);
        handedness_weak_choices_colors[key] = 'ffffff';
    };
    var handedness_weak_drop_reverse = {{gloss.handedness_weak_drop_prop_json|safe}};
    var handedness_weakdrop = handedness_weak_drop_reverse['{{gloss.weakdrop}}'];
    var handedness_weakprop = handedness_weak_drop_reverse['{{gloss.weakprop}}'];
    //console.log('weakdrop: '+handedness_weakdrop);
    //console.log('weakprop: '+handedness_weakprop);
    var dialects = {{gloss.dialect_choices|safe}};
    {% if SHOW_DATASET_INTERFACE_OPTIONS %}
    var dataset_choices = {{dataset_choices|safe}};
    {% else %}
    var dataset_choices = {};
    {% endif %}
    var gloss_dataset_id = {{ gloss.lemma.dataset.id}};
    var gloss_default_language_code = '{{gloss.lemma.dataset.default_language.language_code_2char}}';
    var wordclass_choices = {{gloss.wordclass_choices|safe}};

    var choice_lists = [];
    var static_choice_lists = {{static_choice_lists|safe}};
//    console.log('static choices: '+static_choice_lists);
    var static_choice_list_colors = {{static_choice_list_colors|safe}};
//    console.log('static colors: '+static_choice_list_colors);

    var generate_translated_choice_list_table = {{generate_translated_choice_list_table|safe}};

    var csrf_token = '{{csrf_token}}';
    var next_gloss_id = {{nextglossid}};
    var next_morpheme_id;
    var this_gloss_id = {{gloss.id}};

    var search_results_url = '{% url 'dictionary:ajax_search_results' %}';

    {% include "dictionary/search_result_bar.html" %}

    function validateForm(formId,targetObjectId,thisGlossID,mustChooseAlert,mustBeDifferentAlert) {
        var target_object = document.forms[formId][targetObjectId].value;
        var this_gloss = document.forms[formId][thisGlossID].value;
        if (target_object == "") {
            alert(mustChooseAlert);
            return false;
        }
        if (target_object == this_gloss) {
            alert(mustBeDifferentAlert);
            return false;
        }
    }

    function reloadVideo() {
        console.log('reload video');
        var video_player = document.getElementById("videoplayer");
        video_player_src = video_player.src;
        console.log('url is ' + video_player_src);
        video_player_src = "";
        video_player.src = video_player_src;
        video_player.type = "video/mp4";
        video_player.load();
    }

    $('[data-toggle="tooltip"]').tooltip({
        placement : 'bottom'
    });

    //Fill choice_lists without frequencies now
    $.ajax("{{PREFIX_URL}}/dictionary/ajax/choice_lists/?dataset={{gloss.lemma.dataset}}").done( function (data)
    {
        choice_lists = $.extend(data,{{other_media_field_choices | safe}});
        console.log("Added field choices");
    });

    //Fill choice_lists with frequencies later
    $(document).ready(function() {
        $.ajax("{{PREFIX_URL}}/dictionary/ajax/choice_lists/?include_frequencies=true&dataset={{gloss.lemma.dataset}}").done( function (data)
        {
            choice_lists = $.extend(data,{{other_media_field_choices | safe}});

            // Reload the data in the lists
            $('.edit_list').unbind('click');
            configure_edit();

            console.log("Added field choices");
        });
    });

    //Keyboard shortcuts
    document.onkeydown = checkKey;

    function checkKey(e)
    {
        // No shortcut if your typing
        if (document.activeElement.tagName == 'INPUT') {return;}

        e = e || window.event;

        switch(e.key)
        {
          case 'p':
            element_id = 'phonology'
            break;
          case 'm':
            element_id = 'morphology'
            break;
          case 's':
            element_id = 'semantics'
            break;
          default:
            element_id = null
        }

        if (element_id != null)
        {
            toggle_edit();
            $('#'+element_id).collapse('show');
            $('#'+element_id)[0].scrollIntoView();
        }

    }

    </script>

    <script type='text/javascript' src="{{ STATIC_URL }}js/gloss_edit_color.js"></script>

    <!-- Expand and collapse all panels -->
    <script type='text/javascript'>
        // This script gets minimal pairs data and displays it as table rows
        $(document).ready(function() {
            lookup = "#header_mp_rows";
            $.ajax({
                url : url + "/ajax/minimalpairs/" + this_gloss_id + "/",
                datatype: "json",
                async: true,
                data: { 'gloss_detail': true },
                success : function(result) {
                    var parsed = $.parseHTML(result);
                    $(lookup).first().append(result);
                }
            });
        });

        $('#searchresults').css({'padding-top': 10});
        $('#definitionblock').css({'padding-top': Math.round($('#searchresults').height() + $('#signinfo').height() + 10)});
        $('#expand-panels').on('click', function() {
            $('#definition .collapse').collapse('show');
        });
        $('#collapse-panels').on('click', function() {
            $('#definition .collapse').collapse('hide');
        });
        $('#panel-expand-collapse-btn-group').affix({
            offset: {
                top: $('#panel-expand-collapse-btn-group').offset().top - $('#signbank-bar').height() - $('#signinfo').height()
                 + parseInt($('#signbank-bar').css('margin-bottom'))
                 + parseInt($('#panel-expand-collapse-btn-group').css('height')),
            }
        });
        $('#panel-expand-collapse-btn-group').on('affixed.bs.affix', function() {
            $('#panel-expand-collapse-btn-group').css({
                'margin-left': '-' + $('#panel-expand-collapse-btn-group').width() + 'px',
                'top': ($('#signbank-bar').height() - $('#navbar').height() + parseInt($('#definitionblock').css('padding-top')) + 3) + 'px',
            });
         });
        $('#panel-expand-collapse-btn-group').on('affixed-top.bs.affix', function() {
            $('#panel-expand-collapse-btn-group').css({
                'margin-left': '-' + $('#panel-expand-collapse-btn-group').width() + 'px',
                'top': '0px',
            });
         });
         $('#panel-expand-collapse-btn-toolbar').css({
            'height': $('#panel-expand-collapse-btn-group').css('height'),
         });
    </script>
{% endblock %}

{% block extrahead %}
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/tagmanager.css">
    <style>
        #panel-expand-collapse-btn-group.affix {
            position:fixed;
        }
    </style>
<style>
.preview {
    background-color: white !important;
    height: 40;
    width: auto;
    position: relative;
    padding: 0 0 0 0 !important;
}

select option {
    background-color: white;
    -webkit-appearance: none;
    -moz-appearance: none;
}

.hasTooltip:hover .isTooltip {
    display: block;
    background-color: white;
    border-radius: 5px;
    color: black;
    box-shadow: 1px 1px 3px gray;
    position: absolute;
    padding: 5px;
    top: 3em;
    left: 0px;
    max-width: 360px;
    min-width: 300px;
    font-size: 12px;
    z-index: 9999;
    -webkit-appearance: none;
    -moz-appearance: none;
}

.bootstrap-select.btn-group .dropdown-menu li a:hover {
    color: blue !important;
    background-color: white !important;
    -webkit-appearance: none;
    -moz-appearance: none;
}

.dropdown-menu {
    display: visible !important;
    z-index: 5;
    box-shadow: 0 10px 10px #333;
}

.dropdown-item:active{
    color: blue;
    background-color: darkviolet;
}

.btn-default:hover, .btn-default:focus, .btn-default:active, .btn-default.active, .open .dropdown-toggle.btn-default {
    background-color: white;
    -webkit-appearance: none;
    -moz-appearance: none;
    color: black;
    border-color: #31347B;
}

.bootstrap-select {
    color: black !important;
    background-color: white !important;
    -webkit-appearance: none;
    -moz-appearance: none;
}

.color-picker {
    padding: 0 0 0 0;
    color: black !important;
    background-color: white !important;
    display: visible;
    -webkit-appearance: none;
    -moz-appearance: none;
}

.color-picker select {
    color: black !important;
    background-color: white !important;
    -webkit-appearance: none;
    -moz-appearance: none;
}

.color-picker select option {
    color: black !important;
    background-color: white !important;
    -webkit-appearance: none;
    -moz-appearance: none;
}

input[type="color"] {
    width: 3rem;
    height: 3rem;
    padding: .5rem;
    background-color: #ffffff !important;
    border: 0;
    border-radius: 100%;
}
</style>
<style>
.form-group {
    background-color: white;
    color: black;
}
option:not(:checked) {
    background-color: white !important;
    color: #000;
}
</style>

{% endblock %}

{% block content %}

<div id="searchresults" class='navbar' style="overflow-y:hidden;background-color:white;border:0;box-sizing:content-box; z-index: 50;">
    {% if request.session.search_results %}{# See if search_results in sessions is empty #}
    <div id="results-inline" class="btn-group" role="group" aria-label="search results" style="white-space:nowrap;background-color:white;">
    </div>
    {% endif %}
</div>

{% if request.GET.warning %}
<div class="alert alert-warning">{{ request.GET.warning }}</div>
{% endif %}


<div id="signinfo" class='navbar navbar-collapse' style="background-color:white;border:0;">

    <div class='btn-group'>
        {% if SIGN_NAVIGATION %}

            {% if navigation.prev %}
            <a class='btn navbar-btn btn-default' href="{% url 'dictionary:admin_gloss_view' pk=navigation.prev.id %}">&laquo;{% trans "Previous Sign" %]
            </a>
            {% endif %}

            <button class='btn navbar-btn'>{% blocktrans %}"Sign {{glossposn}} of {{glosscount}} in the dictionary" {% endblocktrans %}</button>

            {% if navigation.next %}
            <a class="btn navbar-btn btn-default"
               href="{% url 'dictionary:admin_gloss_view' pk=navigation.next.id %}">{% trans "Next Sign &raquo;" %}</a>
            {% endif %}
         {% endif %}
    </div>

    <ul class='nav nav-tabs'>
        <li class="nav-item">
            <a class='nav-link' href="{{PREFIX_URL}}/dictionary/gloss/{{gloss.id}}.html">{% trans "Public View" %}</a>
        </li>
        <li class="nav-item">
            <a class='nav-link active' href="{{PREFIX_URL}}/dictionary/gloss/{{gloss.id}}">{% trans "Detail View" %}</a>
        </li>
        <li class="nav-item">
            <a class='nav-link' href="{{PREFIX_URL}}/dictionary/gloss_relations/{{gloss.id}}">{% trans "Relations View" %}</a>
        </li>
        {% if gloss.has_frequency_data %}
        <li class="nav-item">
            <a class='nav-link' href="{{PREFIX_URL}}/dictionary/gloss_frequency/{{gloss.id}}/">{% trans "Frequency View" %}</a>
        </li>
        {% endif %}
        <li class="nav-item">
            <a class='nav-link' href="{{PREFIX_URL}}/dictionary/gloss/{{gloss.id}}/history">{% trans "Revision history" %}</a>
        </li>
    </ul>

    {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
    {% if "change_dataset" in dataset_perms %}
    <div class='pull-right' style="margin-right:15px;margin-top:10px;z-index:100;">

         <span id='edit_message' style="padding-right: 1.8em;"></span>
         <!--<button id='rewind' class='btn btn-default navbar-btn button-to-appear-in-edit-mode' data-toggle='modal' data-target=''>Rewind</button>-->
         <button id='save_and_next_btn' class='btn btn-default navbar-btn button-to-appear-in-edit-mode' data-toggle='modal' data-target=''>{% trans "Edit next gloss" %}</button>

         <button id='enable_edit' class='btn btn-default navbar-btn'>{% trans "Edit" %}</button>

    </div>
    {% endif %}

</div>


        {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
        {% if "change_dataset" in dataset_perms %}
        <div class="modal fade" id="delete_gloss_modal" tabindex="-1" role="dialog" aria-labelledby="#modalTitleDelete" aria-hidden="true">
             <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <div class='modal-header'>
                        <h2 id='modalTitleDelete'>{% trans "Delete This Sign" %}</h2>
                    </div>
                    <div class='modal-body'>
                        <p>{% trans "This action will delete this sign and all associated records. It cannot be undone." %}</p>
                     </div>
                  <form action="{% url 'dictionary:update_gloss' gloss.id %}" method='post'>
                      {% csrf_token %}
                      <input type='hidden' name='id' value='deletegloss'>
                      <input type='hidden' name='value' value='confirmed'>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
                        <input type="submit" class="btn btn-primary" value='{% trans "Confirm Delete" %}'>
                      </div>
                  </form>

                </div>
            </div>
        </div>
        {% endif %}

<div id="definitionblock" style="z-index:0;">
    {% url 'dictionary:protected_media' '' as protected_media_url %}
    <div id="leftblock">
    <div id="videocontainer">
    {% if gloss.has_video %}

     <!-- {{ gloss.get_video }} -->

        <div id="player">
          <video id='videoplayer' src="{{protected_media_url}}{{gloss.get_video_url}}" controls type="video/mp4" autoplay muted></video>
        </div>
        <div id="replay"></div>

    {% else %}
    <div id='player'>
     <img id='novideo' src='{{ STATIC_URL }}images/no-video-ngt.png'>
     <!-- {{ gloss.get_video }} -->
    </div>
    {% endif %}

    </div>

    <div>
        {% if gloss.get_image_path %}
            <img id="imageframe" src="{{protected_media_url}}{{gloss.get_image_url}}" style="height:259px;width:auto;">
        {% endif %}
    </div>

    <div id="feedback">
        <ul>
            <li><a href="{{PREFIX_URL}}/feedback/gloss/{{gloss.id}}?return=/dictionary/gloss/{{gloss.id}}/">{% trans "Provide feedback about this sign" %}</a></li>
        </ul>
    </div>

    {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
    {% if "change_dataset" in dataset_perms %}
    <div class='editform'>
        <fieldset>
            <legend>{% trans "Upload New Video" %}</legend>

            <form action="{{PREFIX_URL}}/video/upload/" method="post" enctype="multipart/form-data" onsubmit="return reloadVideo()">
              {% csrf_token %}
              <input type='hidden' name='redirect' value='{{request.path}}?edit'>
            <table id="staffops">
              <tr>
                  <td>{{videoform.videofile}}</td>
              </tr>
              <tr>
                  <td><input type='hidden' name='gloss_id' value='{{gloss.pk}}'>
                      <input class='btn btn-primary' type='submit' value='Upload Video' /></td>
              </tr>
            </table>
            </form>
        </fieldset>

    </div>
    {% endif %}

    {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
    {% if "change_dataset" in dataset_perms %}
    <div class='editform'>
        <fieldset>
            <legend>{% trans "Upload New Citation Form Image" %}</legend>
            <form action="{{PREFIX_URL}}/image/upload/" method="post" enctype="multipart/form-data">
              {% csrf_token %}
              <input type='hidden' name='redirect' value='{{request.path}}?edit'>
            <table id="staffops">
              <tr>
                  <td>{{imageform.imagefile}}</td>
              </tr>
              <tr>
                  <td><input type='hidden' name='gloss_id' value='{{gloss.pk}}'>
                      <input class='btn btn-primary' type='submit' value='Upload Citation Form Image'/></td>
              </tr>
            </table>
            </form>
        </fieldset>
    </div>
    {% endif %}

    {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
    {% if gloss.has_video and "change_dataset" in dataset_perms %}
        <div class="editform">
            <legend>{% trans "Create Citation Form Image from Current Video" %}</legend>
            <a href="{% url 'dictionary:create_citation_image'  gloss.id %}" class="btn btn-primary">Create</a>
        </div>

    {% endif %}

    {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
    {% if "change_dataset" in dataset_perms %}
    <div class="editform">
        <fieldset>
         <legend>{% trans "Delete Media" %}</legend>
            <table>
                <tr><td>
                <form class="formbutton" action="{{PREFIX_URL}}/video/delete/{{gloss.pk}}" method='post'>
                        {% csrf_token %}<input class='btn btn-danger' id='delete_video' type='submit' value='Delete video'>
                </form>
                <form class="formbutton" action="{{PREFIX_URL}}/image/delete/{{gloss.pk}}" method='post'>
                        {% csrf_token %}<input class='btn btn-danger' id='delete_image' type='submit' value='Delete image'>
                </form>
                </td></tr>
            </table>
         </fieldset>
    </div>
    {% endif %}

     {% if "change_dataset" in dataset_perms %}
    <div class="editform">
        <fieldset>
         <legend>{% trans "Delete Sign" %}</legend>
         <button id='delete_gloss_btn' class='btn btn-danger' data-toggle='modal' data-target='#delete_gloss_modal'>{% trans "Delete Sign" %}</button>
        </fieldset>
    </div>
    {% endif %}



</div>


    <div class='panel-group' id="definition" style="z-index: 0;opacity:.99; position: relative; background-color: white;">

        {% include "dictionary/glosstags.html" %}

        <table class='table table-condensed'>
            <tr {%if gloss_dialects|length == 0 %} class="empty_row"{% endif %}><th>{% trans "Dialect" %}</th><td class='edit edit_dialect' id='dialect' colspan="2">{% for dia in gloss_dialects %}{{dia}}{% if not forloop.last %}, {% endif %}{% endfor %}</td></tr>
            <tr><th>{% trans "Lemma ID Gloss" %}</th>

                <td style="width:600px;"><span id="lemma">{{ gloss.lemma }}
                        {% if lemma_group %}
                            <a href='{{lemma_group_url}}' title='{% trans "Show lemma group" %}'><span class="glyphicon glyphicon-th-list"></span></a>
                        {% endif %}
                    </span>
                </td></tr>
            <tr class="empty_row lemma_buttons" id="lemma-buttons-group" name="lemma-buttons-group"><th></th>
                <td>
                    <div id="lemma_buttons" name="lemma_buttons" class="btn-group">
                        <button id='show_edit_lemma_form' name='show_edit_lemma_form'
                                class='btn btn-primary btn-space'>{% trans "Edit lemma" %}</button>
                        <button id='show_set_lemma_form' name='show_set_lemma_form'
                                class='btn btn-primary btn-space'>{% trans "Choose other" %}</button>
                        <button id='show_create_lemma_form' name='show_create_lemma_form'
                                class='btn btn-primary btn-space'>{% trans "Create new" %}</button>
                    </div>
                </td></tr>
                <tr name="lemma_forms_row"><th></th>
                    <td name="lemma_forms_cell">
                    <form name='edit_lemma_form' id='edit_lemma_form'
                          method='post' action='{% url "dictionary:change_lemma" gloss.lemma.id %}'>
                         {% csrf_token %}
                        <input type="hidden" class='btn btn-primary'
                            value='{% trans "Edit lemma" %}'
                            type='submit'>
                        <input type='hidden' name='gloss_lemma_id' value='{{gloss.lemma.id}}'>
                        <input type='hidden' id="page" name="page" value=''>
                    </form>
                    <form name='set_lemma_form' id='set_lemma_form'
                     onsubmit='return validateForm("set_lemma_form","value","gloss_lemma_id",
                                                    "Please choose a lemma.",
                                                    "Target lemma must be different from the current lemma of this gloss.")'
                     method='post' action='{% url "dictionary:update_gloss" gloss.id %}'>
                        {% csrf_token %}
                        <!-- Input that holds the current lemma id; used by validateForm -->
                        <input type='hidden' name='gloss_lemma_id' value='{{gloss.lemma_id}}'>

                        <!-- Input of the type ahead -->
                        <input class='form-control lemmatypeahead' placeholder='{% trans "Lemma" %}' />

                        <!-- Input for gloss_update (2) / Input that holds the lemma id the user chose from the type ahead -->
                        <input type='hidden' name='value' value='confirmed'>
                        <!-- Input for gloss_update (1) -->
                        <input type='hidden' name='id' value='lemmaidgloss'>
                        <!-- Submit -->
                        <input class='btn btn-primary' value='{% trans "Set lemma" %}' type='submit'>
                        <button type="button" class="btn btn-default lemma-form-dismiss">{% trans "Cancel" %}</button>
                    </form>
                    <form name="add_lemma_form" id="add_lemma_form" method="post" action="{% url 'dictionary:create_lemma_gloss' gloss.id %}" >
                        {% csrf_token %}
                        <input type="hidden" name="dataset" value="{{ gloss.lemma.dataset.id }}"/>
                        {% for dataset_lang in gloss.lemma.dataset.translation_languages.all %}
                        {{ dataset_lang.name }}:
                        <input id="{{ lemma_create_field_prefix }}{{ dataset_lang.language_code_2char }}"
                               name="{{ lemma_create_field_prefix }}{{ dataset_lang.language_code_2char }}"
                               required="" maxlength="30" type="text"/>

                        {% endfor %}
                        <!-- Submit -->
                        <input class='btn btn-primary' value='{% trans "Add lemma" %}' type='submit'>
                        <button type="button" class="btn btn-default lemma-form-dismiss">{% trans "Cancel" %}</button>
                    </form>
                </td>

            </tr>

            {% for lang, annotation_idgloss_translations in annotation_idgloss.items %}
            <tr>
                <th>
                    {% trans "Annotation ID Gloss" %} ({{ lang }})
                </th>
                <td class='edit edit_text' id='annotation_idgloss_{{ lang.language_code_2char }}' colspan="2">{{ annotation_idgloss_translations.0.text|safe }}</td>
                <td>
                    {% if gloss.simultaneous_morphology.all.count > 0 %}

                        {% if gloss.simultaneous_morphology.all.count > 2 %}
                        <span class="gloss_detail_morpheme">({{gloss.simultaneous_morphology.all.count}} morphemes)</span>
                        {% else %}
                            <!-- Number of morphemes is [1-2] -->
                            {% for morphdef in gloss.simultaneous_morphology.all %}
                            <span class="gloss_detail_morpheme"><a href='{% url "dictionary:admin_morpheme_view" pk=morphdef.pk %}'>
                                {% value morphdef.morpheme|get_annotation_idgloss_translation:lang %}</a>{% if not forloop.last %}, {% endif %}
                            </span>
                            {% endfor %}
                        {% endif %}

                    {% endif %}

                    {% if gloss.parent_glosses.all.count > 0 %}
                    {% with gloss.parent_glosses.all as components %}
                    {% with components|dictsort:"role" as sorted_components %}
                    {% for component in sorted_components %}
                    <span class="gloss_detail_component"><a href='{% url "dictionary:admin_gloss_view" pk=component.morpheme.pk %}'>
                        {% value component.morpheme|get_annotation_idgloss_translation:lang %}</a>{% if not forloop.last %} + {% endif %}
                    </span>
                    {% endfor %}
                    {% endwith %}
                    {% endwith %}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}

            {% for lang, translations in translations_per_language.items %}
            <tr>
                <th>
                    {% trans "Translation equivalents for" %} {{ lang }}
                </th>
                <td class='edit edit_text' id='keywords_{{ lang.language_code_2char }}' colspan="2">{% for trn in translations %}{{ trn.translation.text|safe }}{% if not forloop.last %}, {% endif %}{% endfor %}</td>
            </tr>
            {% endfor %}

            {% for value,name,label,kind in main_fields %}
                <tr><th>{{label}}</th>
                    <td class="edit edit_{{kind}}" id='{{name}}'
                        value='{{value}}'>{% if kind == "check" and value %}{% trans "Yes" %}{% elif kind == "check" %}{% trans "No" %}{% else %}{% value value %}{% endif %}</td></tr>
            {% endfor %}

        </table>


   {% if perms.dictionary.view_advanced_properties %}

        <!-- Expand and collapse all panels -->
        <div class="btn-toolbar" role="toolbar" id="panel-expand-collapse-btn-toolbar">
            <div class="pull-right">
                <div class="btn-group" id="panel-expand-collapse-btn-group">
                    <button id="expand-panels" type="button" class="btn btn-default btn-xs">
                            <span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span>
                    </button>
                    <button id="collapse-panels" type="button" class="btn btn-default btn-xs">
                        <span class="glyphicon glyphicon-chevron-up" aria-hidden="true"></span>
                    </button>
                </div>
            </div>
        </div>

   <!-- Morphology -->
   <div class="panel panel-default">
        <div class='panel-heading'>
            <div class='panel-title'>
                <a data-toggle='collapse' data-parent='#morphologydefinition' href='#morphology'>{% trans "Morphology" %}</a>
            </div>
        </div>
        <div id='morphology' class='collapse'>

            <!-- List the glosses that serve as compound parts of 'me', and allow Adding/Deleting these parts -->

               <table class='table table-condensed'>
                   <tr>
                       <th colspan="3">{% trans "Sequential Morphology" %}</th>
                   </tr>
                   {% if gloss.parent_glosses.count > 0 %}
                  <tr>
                      <th style="width:2em;"></th>
                      <th style="width:12em;">{% trans "Compound part" %}</th>
                      <th>{% trans "Component sign" %}</th>
                  </tr>

                   {% for morphdef, translated_role, sign_display in morphdefs %}

                   <tr>
                       {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
                       {% if "change_dataset" in dataset_perms %}
                         <td style='width:2em;'>
                            <span class='glyphicon glyphicon-trash morphology-definition-delete' data-toggle='modal' data-target='#delete_morphology-definition_modal_{{morphdef.id}}'></span>

                             <div class="modal fade" id="delete_morphology-definition_modal_{{morphdef.id}}" role="dialog" aria-labelledby="#modalTitleComp" aria-hidden="true">
                                 <div class="modal-dialog modal-sm">
                                    <div class="modal-content">
                                        <div class='modal-header'>
                                            <h2 id='modalTitleComp'>{% trans "Delete This Compound part" %}</h2>
                                        </div>
                                        <div class='modal-body'>

                                            <p>{% trans "Are you sure you want to delete this? This cannot be undone." %}</p>
                                         </div>
                                      <form action='{% url "dictionary:update_gloss" gloss.id %}' method='post'>
                                          {% csrf_token %}
                                          <input type='hidden' name='id' value='morphology-definition-delete_{{morphdef.id}}'>
                                          <input type='hidden' name='value' value='confirmed'>
                                          <div class="modal-footer">
                                            <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
                                            <input type="submit" class="btn btn-primary" value='{% trans "Confirm Delete" %}'>
                                          </div>
                                      </form>

                                    </div>
                                  </div>
                             </div>

                        </td>
                        {% else %}
                        <td></td>
                        {% endif %}
                        <td id='morphology-definition-role_{{morphdef.id}}' >{{translated_role}}</td>
                        <td id='morphology-definition-morpheme_{{morphdef.id}}'><a href='{% url "dictionary:admin_gloss_view" pk=morphdef.morpheme.pk %}'>{{sign_display}}</a></td>
                   {% endfor %}

            {% else %}
            <tr><td><i>({% trans "If this is a compound, use [Edit] to define its components" %})</i></td></tr>
            {% endif %}
           </table>

            {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
            {% if "change_dataset" in dataset_perms %}
            <form name="add_morphologydefinition_form" id='add_morphologydefinition_form'
                  onsubmit='return validateForm("add_morphologydefinition_form","morpheme_id","parent_gloss_id",
                                                "Please choose a gloss for Add Component Morphology.",
                                                "Component gloss must be different from this gloss for Add Component Morphology.")'
                  method='post' action="{% url 'dictionary:add_morphologydefinition' %}">
               {% csrf_token %}
               <input type='hidden' name='parent_gloss_id' value='{{gloss.pk}}'>
               <table class='table table-condensed'>
                   <tr>
                       <td style="width:2em;"></td>
                       <td style="width:12em;">{{morphologyform.role}}</td>
                       <td>
                           <input class='form-control glosstypeahead' placeholder='{% trans "Annotation ID Gloss" %}' />
                           <input type="hidden" name="morpheme_id" value=""/>
                       </td>
                       <td><input id="add_component" class='btn btn-primary' value='{% trans "Add Component" %}' type='submit'></td>
                   </tr>
               </table>
            </form>
            {% endif %}

            <table class='table table-condensed'>
                <tr>
                    <th colspan="4">{% trans "Simultaneous Morphology" %}</th>
                </tr>
                {% if SHOW_DATASET_INTERFACE_OPTIONS %}
                {% if count_morphemes_in_dataset < 1 %}
                <tr>
                    <td colspan="4"><i>({% trans "There are no morphemes in the dataset of this gloss." %})</i></td>
                </tr>
                {% else %}
                <tr>
                    <th style="width:2em;"></th>
                    <th style="width:22em;">{% trans "Morpheme gloss" %}</th>
                    <th colspan="2">{% trans "Meaning in this sign" %}</th>
                </tr>
                {% endif %}
                {% else %}
                <tr>
                    <th style="width:2em;"></th>
                    <th style="width:22em;">{% trans "Morpheme gloss" %}</th>
                    <th colspan="2">{% trans "Meaning in this sign" %}</th>
                </tr>
                {% endif %}

                {% for morpheme, morph_display, morpheme_type in simultaneous_morphology %}
                <tr>
                    <!-- Facility to delete this morpheme -->
                    {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
                    {% if "change_dataset" in dataset_perms %}
                     <td>
                        <span class='glyphicon glyphicon-trash morpheme-definition-delete' data-toggle='modal' data-target='#delete_morpheme-definition_modal_{{morpheme.pk}}'></span>

                         <div class="modal fade" id="delete_morpheme-definition_modal_{{morpheme.pk}}" role="dialog" aria-labelledby="#modalTitleMrp" aria-hidden="true">
                             <div class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <div class='modal-header'>
                                        <h2 id='modalTitleMrp'>{% trans "Delete This Morpheme" %}</h2>
                                    </div>
                                    <div class='modal-body'>

                                        <p>{% trans "Are you sure you want to delete this? This cannot be undone." %}</p>
                                     </div>
                                  <form action='{% url "dictionary:update_gloss" gloss.id %}' method='post'>
                                      {% csrf_token %}
                                      <input type='hidden' name='id' value='morpheme-definition-delete_{{morpheme.pk}}'>
                                      <input type='hidden' name='value' value='confirmed'>
                                      <div class="modal-footer">
                                        <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
                                        <input type="submit" class="btn btn-primary" value='{% trans "Confirm Delete" %}'>
                                      </div>
                                  </form>

                                </div>
                              </div>
                         </div>

                    </td>
                    {% else %}
                    <td></td>
                    {% endif %}
                    <td id='morpheme-definition_{{morpheme.pk}}'>
                        <a href='{% url "dictionary:admin_morpheme_view" pk=morpheme.morpheme.pk %}'>{{morph_display}} ({{morpheme_type}})</a></td>
                    <td class='edit edit_text' id='morpheme-definition-meaning_{{morpheme.pk}}'>{{morpheme.role}}</td>
               </tr>
                {% endfor %}
            </table>

            <!-- Facilitate adding and deleting morphemes that are used in this sign -->
            {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
            {% if "change_dataset" in dataset_perms %}
            {% if count_morphemes_in_dataset %}
            <form name='add_morphemedefinition_form' id='add_morphemedefinition_form'
                  onsubmit='return validateForm("add_morphemedefinition_form","morph_id","host_gloss_id",
                                                "Please choose a morpheme for Add Morpheme Morphology.",
                                                "Morpheme must be different from this gloss for Add Morpheme Morphology.")'
                  method='post' action="{% url 'dictionary:add_morphemedefinition' glossid=gloss.id %}">
               {% csrf_token %}
               <input type='hidden' name='host_gloss_id' value='{{gloss.pk}}'>
               <table class='table table-condensed'>
                   <tr>
                       <td style="width:2em;"></td>
                       <td style="width:22em;">
                           <input class='form-control morphtypeahead' placeholder='{% trans "Morpheme gloss" %}' value="{{morphemeform.morph_id.value|default:''}}"/>
                           <input type="hidden" name='morph_id' value=""/>
                       </td>
                       <td><input class='form-control' placeholder='{% trans "Meaning in this sign" %}' name='description' value="{{morphemeform.description.value|default:''}}"/></td>
                       <td><input class='btn btn-primary' value='{% trans "Add Morpheme" %}' type='submit'></td>
                   </tr>
               </table>
               {# spacing div to allow room for typeahead dropdown #}
               <div style='height: 10em'></div>
             </form>
            {% endif %}
            {% endif %}

            <table class='table table-condensed'>
                <tr>
                    <th colspan="4">{% trans "Blend Morphology" %}</th>
                </tr>
                <tr>
                    <th style="width:2em;"></th>
                    <th style="width:22em;">{% trans "Blend gloss" %}</th>
                    <th colspan="2">{% trans "Role in this sign" %}</th>
                </tr>
                {% for blend, blend_display in blend_morphology %}
                <tr>
                    <!-- Facility to delete this blend -->
                    {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
                    {% if "change_dataset" in dataset_perms %}
                     <td>
                        <span class='glyphicon glyphicon-trash blend-definition-delete' data-toggle='modal' data-target='#delete_blend-definition_modal_{{blend.pk}}'></span>

                         <div class="modal fade" id="delete_blend-definition_modal_{{blend.pk}}" role="dialog"
                              aria-labelledby="#modalTitleBlend" aria-hidden="true">
                             <div class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <div class='modal-header'>
                                        <h2 id='modalTitleBlend'>{% trans "Delete This Blend" %}</h2>
                                    </div>
                                    <div class='modal-body'>

                                        <p>{% trans "Are you sure you want to delete this? This cannot be undone." %}</p>
                                     </div>
                                  <form action='{% url "dictionary:update_gloss" gloss.id %}' method='post'>
                                      {% csrf_token %}
                                      <input type='hidden' name='id' value='blend-definition-delete_{{blend.pk}}'>
                                      <input type='hidden' name='value' value='confirmed'>
                                      <div class="modal-footer">
                                        <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
                                        <input type="submit" class="btn btn-primary" value='{% trans "Confirm Delete" %}'>
                                      </div>
                                  </form>

                                </div>
                              </div>
                         </div>

                    </td>
                    {% else %}
                    <td></td>
                    {% endif %}
                    <td id='blend-definition_{{blend.pk}}'><a href='{% url "dictionary:admin_gloss_view" pk=blend.glosses.pk %}'>{{blend_display}}</a></td>
                    <td class='edit edit_text' id='blend-definition-role_{{blend.pk}}'>{{blend.role}}</td>
               </tr>
                {% endfor %}
            </table>

            <!-- Facilitate adding and deleting blends that are used in this sign -->
            {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
            {% if "change_dataset" in dataset_perms %}
            <form name='add_blenddefinition_form' id='add_blenddefinition_form'
                  onsubmit='return validateForm("add_blenddefinition_form","blend_id","host_gloss_id",
                                                "Please choose a gloss for Add Blend Morphology.",
                                                "Blend gloss must be different from this gloss for Add Blend Morphology.")'
                  method='post' action="{% url 'dictionary:add_blenddefinition' glossid=gloss.id %}">
               {% csrf_token %}
               <input type='hidden' name='host_gloss_id' value='{{gloss.pk}}'>
               <table class='table table-condensed'>
                   <tr>
                       <td style="width:2em;"></td>
                       <td style="width:22em;">
                           <input class='form-control glosstypeahead' placeholder='{% trans "Blend gloss" %}' value="{{blendform.blend_id.value|default:''}}"/>
                           <input type="hidden" name='blend_id' value=""/>
                       </td>
                       <td><input class='form-control' placeholder='{% trans "Role in this sign" %}' name='role' value="{{blendform.role.value|default:''}}" required=""/></td>
                       <td><input class='btn btn-primary' value='{% trans "Add Blend" %}' type='submit'></td>
                   </tr>
               </table>
               {# spacing div to allow room for typeahead dropdown #}
               <div style='height: 10em'></div>
            </form>
            {% endif %}

        </div>

    </div>

    <!-- Phonology -->
	<div class="panel panel-default">
        <div class='panel-heading'>
            <div class='panel-title' id='phonology_heading'>
                <a data-toggle='collapse' href='#phonology'>{% trans "Phonology" %}</a><span id='phonology_message'></span>
                {% if handedness and domhndsh %}
                <div class="pull-right">
                <span id="hands-icon"><img id='phono-hands' src='{{ STATIC_URL }}images/raised_hand_with_fingers_splayed.png' style="width:18px; height:auto; margin: 0px;"></span>
                </div>
                {% endif %}
            </div>
        </div>
        <div id='phonology' class='panel-collapse collapse'>
            <table class='table table-condensed'>
		    {% for value,name,label,kind in phonology_fields %}
                {% if name == 'handedness' %}
                    <tr class="empty_row">
                        <th/><th/><th>WD</th><th>WP</th>
                    </tr>
                    {% if value == '-' or value == ' ' or value == '' or value == None %}
                    <tr class="empty_row">
                        <th>{{label}}</th>
                        <td class="edit edit_list" id='{{name}}' value='{{value}}' >{% value value %}</td>
                        {% for value,name,label,kind in handedness_fields %}
                            {% if name == 'weakdrop' %}
                            <td class="edit edit_WD" id='{{name}}'
                                value="{{value}}">{% if value %}+WD{% elif value == None %}&nbsp;{% else %}-WD{% endif %}</td>
                            {% else %}
                            <td class="edit edit_WP" id='{{name}}'
                                value="{{value}}">{% if value %}+WP{% elif value == None %}&nbsp;{% else %}-WP{% endif %}</td>
                            {% endif %}
		                {% endfor %}
                    </tr>
                    {% else %}
                    <tr >
                        <th>{{label}}</th>
                        <td class="edit edit_list" id='{{name}}' value='{{value}}' >{% value value %}</td>
                        {% for value,name,label,kind in handedness_fields %}
                            {% if name == 'weakdrop' %}
                            <td class="edit edit_WD" id='{{name}}'
                                value="{{value}}">{% if value %}+WD{% elif value == None %}&nbsp;{% else %}-WD{% endif %}</td>
                            {% else %}
                            <td class="edit edit_WP" id='{{name}}'
                                value="{{value}}">{% if value %}+WP{% elif value == None %}&nbsp;{% else %}-WP{% endif %}</td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% endif %}
                {% elif name == 'domhndsh' and SHOW_LETTER_NUMBER_PHONOLOGY %}
                    <tr class="empty_row">
                        <th/><th/><th>letter</th><th>number</th>
                    </tr>
                    {% if value == '-' or value == ' ' or value == '' or value == None %}
                    <tr class="empty_row">
                        <th>{{label}}</th>
                        <td class="edit edit_list" id='{{name}}' value='{{value}}' >{% value value %}</td>
                        {% for value,name,label,kind in etymology_fields_dom %}
                            {% if name == 'domhndsh_letter' %}
                            <td class="edit edit_letter" id='{{name}}'
                                value="{{value}}">{% if value %}letter{% else %}&nbsp;{% endif %}</td>
                            {% else %}
                            <td class="edit edit_number" id='{{name}}'
                                value="{{value}}">{% if value %}number{% else %}&nbsp;{% endif %}</td>
                            {% endif %}
		                {% endfor %}
                    </tr>
                    {% else %}
                    <tr >
                        <th>{{label}}</th>
                        <td class="edit edit_list" id='{{name}}' value='{{value}}' >
                            {% with generate_translated_choice_list_table|get_item:name as choices_for_field %}
                            {% with gloss.domhndsh|to_int as domhndsh_value %}
                            {% with choices_for_field|keyvalue:domhndsh_value as translates_for_field %}
                            {% if translates_for_field %}
                            {% with request.LANGUAGE_CODE as language %}
                            {% with translates_for_field|get_item:language as translated_field %}
                            <a id="strong_hand_link" style="color: {% if StrongHand %}inherit{% else %}red{% endif %}; display: visible;"
                               href="{{PREFIX_URL}}/dictionary/handshape/{% if StrongHand %}{{StrongHand}}{% else %}{{value}}{% endif %}/">{{ translated_field }}</a>
                            {% endwith %}
                            {% endwith %}
                            {% else %}
                            <span style="color:red">{{domhndsh_value}}</span>
                            {% endif %}
                            {% endwith %}
                            {% endwith %}
                            {% endwith %}
                        </td>
                        {% for value,name,label,kind in etymology_fields_dom %}
                            {% if name == 'domhndsh_letter' %}
                            <td class="edit edit_letter" id='{{name}}'
                                value="{{value}}">{% if value %}letter{% else %}&nbsp;{% endif %}</td>
                            {% else %}
                            <td class="edit edit_number" id='{{name}}'
                                value="{{value}}">{% if value %}number{% else %}&nbsp;{% endif %}</td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% endif %}
                {% elif name == 'subhndsh' and SHOW_LETTER_NUMBER_PHONOLOGY %}
                    <tr class="empty_row">
                        <th/><th/><th>letter</th><th>number</th>
                    </tr>
                    {% if value == '-' or value == ' ' or value == '' or value == None %}
                    <tr class="empty_row">
                        <th>{{label}}</th>
                        <td class="edit edit_list" id='{{name}}' value='{{value}}' >{% value value %}</td>
                        {% for value,name,label,kind in etymology_fields_sub %}
                            {% if name == 'subhndsh_letter' %}
                            <td class="edit edit_letter" id='{{name}}'
                                value="{{value}}">{% if value %}letter{% else %}&nbsp;{% endif %}</td>
                            {% else %}
                            <td class="edit edit_number" id='{{name}}'
                                value="{{value}}">{% if value %}number{% else %}&nbsp;{% endif %}</td>
                            {% endif %}
		                {% endfor %}
                    </tr>
                    {% else %}
                    <tr >
                        <th>{{label}}</th>
                        <td class="edit edit_list" id='{{name}}' value='{{value}}' >
                            <a id="weak_hand_link" style="color: inherit; display: visible;" href="{{PREFIX_URL}}/dictionary/handshape/{{WeakHand}}/">{{value}}</a>
                        </td>
                        {% for value,name,label,kind in etymology_fields_sub %}
                            {% if name == 'subhndsh_letter' %}
                            <td class="edit edit_letter" id='{{name}}'
                                value="{{value}}">{% if value %}letter{% else %}&nbsp;{% endif %}</td>
                            {% else %}
                            <td class="edit edit_number" id='{{name}}'
                                value="{{value}}">{% if value %}number{% else %}&nbsp;{% endif %}</td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% endif %}
                {% else %}
                <tr {% if value == '-' or value == ' ' or value == '' or value == None or value == False or value == '------' %} class="empty_row"{% endif %}>
                    <th>{{label}}</th>
                    <td class="edit edit_{{kind}}" id='{{name}}' value='{{value}}' >{% if kind == "check" and value %}{% trans "Yes" %}{% elif kind == "check" %}{% trans "No" %}
                                                                    {% else %}{% value value %}{% endif %}</td>
                </tr>
                {% endif %}
		    {% endfor %}

            </table>
        </div>
    </div>

    <!-- Minimal Pairs -->
 {% if homonyms_but_not_saved %}
  <div class="panel panel-default">

        <div class='panel-heading'>
            <div class='panel-title'>
                <a data-toggle='collapse' style="color:red" href='#identicalphonology'>{% trans "Identical phonology but not marked as homonym" %}</a>
            </div>
        </div>
        <div id='identicalphonology' class='panel-collapse collapse'>
            <table class='table table-condensed' style="padding-left: 20px;">
               <tr>
                   <th style="width:auto; padding-left: 25px;">{% trans "Annotation ID Gloss" %}</th>
               </tr>
                {% for gl, homo_display in homonyms_but_not_saved %}
                <tr><td style="color:red;"><a style="color:red; padding-left: 20px;" href='{% url "dictionary:admin_gloss_view" pk=gl.id %}'>{{ homo_display }}</a></td></tr>
                {% endfor %}
            </table>
        </div>
  </div>
 {% endif %}
 {% if homonyms_different_phonology %}
 <div class="panel panel-default">

        <div class='panel-heading'>
            <div class='panel-title'>
                <a data-toggle='collapse' style="color:red" href='#differentphonology'>{% trans "Marked as homonym but different phonology" %}</a>
            </div>
        </div>
        <div id='differentphonology' class='panel-collapse collapse'>
            <table class='table table-condensed' style="padding-left: 20px;">
               <tr>
                   <th style="width:auto; padding-left: 25px;">{% trans "Annotation ID Gloss" %}</th>
               </tr>
                {% for gl, homo_display in homonyms_different_phonology %}
                <tr><td><a href='{% url "dictionary:admin_gloss_view" pk=gl.id %}'>{{ homo_display }}</a></td></tr>
                {% endfor %}
            </table>
        </div>
  </div>
{% endif %}
<div class="panel panel-default">
        <div class='panel-heading'>
            <div class='panel-title'>
                <a data-toggle='collapse' href='#minimalpairs'>{% trans "Minimal Pairs" %}</a>
            </div>
        </div>
        <div id='minimalpairs' class='panel-collapse collapse'>
            <table class='table table-condensed' id = "header_mp_rows">

            {% if minimalpairs %}
               <tr>
                   <th style="width:auto; padding:0px 0px;">{% trans "Annotation ID Gloss" %}</th>
                   <th style="width:auto; padding:0px 0px;">{% trans "Field name" %}</th>
                   <th style="width:auto; padding:0px 0px;">{% trans "Source Sign Value" %}</th>
                   <th style="width:auto; padding:0px 0px;">{% trans "Contrasting Sign Value" %}</th>
                </tr>
            {% endif %}
            </table>
        </div>
</div>

    <!-- Semantics -->
    <div class="panel panel-default">
        <div class='panel-heading'>
            <div class='panel-title'>
                <a data-toggle='collapse' href='#semantics'>{% trans "Semantics" %}</a>
                {% if SemanticFieldDefined %}
                <div class="pull-right">
                <span id="semantics-icon"><img id='ball' src='{{ STATIC_URL }}images/black_circle.png' style="width:25px; height:25px; margin: 0px;"></span>
                </div>
                {% endif %}
            </div>
        </div>
        <div id='semantics' class='panel-collapse collapse'>
            <table class='table table-condensed'>
		    {% for value,name,label,kind in semantics_fields %}
	              <tr><th>
                    {% if name == 'concConcSet' %}
                        <a target="_blank" href="http://concepticon.clld.org">{{label}}</a>
                    {% else %}
                        {{label}}
                    {% endif %}
                 </th><td class="edit edit_{{kind}}" id='{{name}}' value='{{value}}'>{% value value %}</td></tr>
            {% endfor %}

            </table>
        </div>
    </div>


    <!-- Relations to other signs -->
    <div class="panel panel-default">
        <div class='panel-heading'>
            <div class='panel-title'>
                <a data-toggle='collapse' href='#relations'>{% trans "Relations to Other Signs" %}</a>
                {% if gloss.relations_count %}
                <div class="pull-right">
                <span id="relations-icon"><img id='relations-arrows' src='{{ STATIC_URL }}images/leftwards_arrow_over_rightwards_arrow.png' style="width:16px; height:auto; margin: 0px;"></span>
                </div>
                {% endif %}
            </div>
        </div>
        <div id='relations' class='collapse'>
               <table class='table table-condensed'>
                   {% for rel, target_display in otherrelations %}
                    <tr id='row_{{rel.id}}'>
                        {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
                        {% if "change_dataset" in dataset_perms %}
                        <td class='edit edit_relation_delete' id='relationdelete_{{rel.id}}' value="delete"><span class='glyphicon glyphicon-trash relation_delete'></span></td>
                        {% else %}
                        <td></td>
                        {% endif %}
                        <td id='relationrole_{{rel.id}}'>{{rel.get_role_display}}</td>
                        <td id='relationtarget_{{rel.id}}'>
                            <a id='relation_target_hyperlink_{{rel.id}}'
                               href='{% url "dictionary:admin_gloss_view" pk=rel.target.pk %}'>{{target_display}}</a></td>
                    </tr>
                   {% endfor %}
               </table>

               {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
               {% if "change_dataset" in dataset_perms %}
               <form name='add_relation_form' id='add_relation_form'
                     onsubmit='return validateForm("add_relation_form","targetid","sourceid",
                                                    "Please choose a target gloss for Add Relation to Other Sign.",
                                                    "Target gloss must be different from this gloss for Add Relation to Other Sign.")'
                     method='post' action='{% url "dictionary:add_relation" %}'>
                   {% csrf_token %}
                   <input type='hidden' name='sourceid' value='{{gloss.pk}}'>
                   <table class='table table-condensed'>
                       <tr>
                           <td>{{relationform.role}}</td>
                           <td>
                               <input class='form-control glosstypeahead' placeholder='{% trans "Annotation ID Gloss" %}'/>
                               <input type="hidden" name="targetid" value=""/>
                           </td>
                           <td><input class='btn btn-primary' value='Add Relation' type='submit'></td>
                       </tr>
                   </table>
                   {# spacing div to allow room for typeahead dropdown #}
                   <div style='height: 10em'></div>
                </form>
                {% endif %}

        </div>
    </div>


    <!-- Relations to foreign signs -->
    <div class="panel panel-default">
        <div class='panel-heading'>
            <div class='panel-title'>
                <a data-toggle='collapse' href='#relationsforeign'>{% trans "Relations to Foreign Signs" %}</a>
                {% if gloss.relationtoforeignsign_set.all %}
                <div class="pull-right">
                <span id="forrelations-icon"><img id='forrelations-arrows' src='{{ STATIC_URL }}images/left_right_triangleheaded_arrow.png' style="width:30px; height:auto; margin: 0px;"></span>
                </div>
                {% endif %}
            </div>
        </div>
        <div id='relationsforeign' class='collapse'>
               <table class='table table-condensed'>
	                <tr>
                        <th style='width:1em'></th>
                        <th style='width:3em'>{% trans "Loan" %}</th>
		                <th style='width:10em'>{% trans "Related Language" %}</th>
		                <th style='width:15em'>{% trans "Gloss in related language" %}</th>
		            </tr>
                   {% for rel in gloss.relationtoforeignsign_set.all %}
                    <tr id='foreign_{{rel.id}}'>
                        {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
                        {% if "change_dataset" in dataset_perms %}
                        <td class='edit edit_foreign_delete' id='relationforeign-delete_{{rel.id}}' value="delete"><span class='glyphicon glyphicon-trash relationtoforeignsign_delete'></span></td>
                        {% else %}
                        <td></td>
                        {% endif %}
                        <td class='edit edit_check' id='relationforeign-loan_{{rel.id}}'
                            value='{{rel.loan}}'>{% if rel.loan %}{% trans "Yes" %}{% else %}{% trans "No" %}{% endif %}</td>
                        <td class='edit edit_text' id='relationforeign-other-lang_{{rel.id}}'>{{rel.other_lang}}</td>
                        <td class='edit edit_text' id='relationforeign-other-lang-gloss_{{rel.id}}'>{{rel.other_lang_gloss}}</td>
                    </tr>
                   {% endfor %}
               </table>

               {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
               {% if "change_dataset" in dataset_perms %}
               <form id='add_relationtoforeignsign_form' method='post' action='{% url "dictionary:add_relationtoforeignsign" %}'>
                   {% csrf_token %}
                   <input type='hidden' name='sourceid' value='{{gloss.pk}}'>
                   <table class='table table-condensed'>
                       <tr>
                           <td><input class='checkbox' name='loan' type='checkbox'></td>
                           <td><input class='form-control' placeholder='{% trans "Related language" %}' name='other_lang' type='text'></td>
                           <td><input class='form-control' placeholder='{% trans "Gloss in related language" %}' name='other_lang_gloss' type='text'></td>
                           <td><input class='btn btn-primary' value='{% trans "Add Relation to Foreign Sign" %}' type='submit'></td>
                       </tr>
                   </table>
                   {# spacing div to allow room for typeahead dropdown #}
                   <div style='height: 10em'></div>
               </form>
               {% endif %}

        </div>
    </div>
    {% endif %}


        <div class="panel panel-default">
            <div class='panel-heading'>
                <div class='panel-title'>
                    <a data-toggle='collapse' href='#frequency'>{% trans "Frequency" %}</a>
                    {% if tokNo == 1 %}
                    <div class="pull-right">
                    <span id="freqency-one-star-icon">
                        <img id='frequency-one-star' src='{{ STATIC_URL }}images/black_star.png' style="width:20px; height:auto; margin: 0px;">
                    </span>
                    </div>
                    {% elif tokNo > 1 and tokNo < 6 %}
                    <div class="pull-right">
                    <span id="freqency-two-stars-icon">
                        <img id='frequency-two-stars_1' src='{{ STATIC_URL }}images/black_star.png' style="width:20px; height:auto; margin: 0px;">
                        <img id='frequency-two-stars_2' src='{{ STATIC_URL }}images/black_star.png' style="width:20px; height:auto; margin: 0px;">
                    </span>
                    </div>
                    {% elif tokNo > 5 %}
                    <div class="pull-right">
                    <span id="freqency-three-stars-icon">
                        <img id='frequency-three-stars_1' src='{{ STATIC_URL }}images/black_star.png' style="width:20px; height:auto; margin: 0px;">
                        <img id='frequency-three-stars_2' src='{{ STATIC_URL }}images/black_star.png' style="width:20px; height:auto; margin: 0px;">
                        <img id='frequency-three-stars_3' src='{{ STATIC_URL }}images/black_star.png' style="width:20px; height:auto; margin: 0px;">
                    </span>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div id='frequency' class='panel-collapse collapse'>
                <table class='table table-condensed'>
                    {% for value,name,label,kind in frequency_fields %}
                    <tr><th>{{label}}</th><td id='{{name}}'>{% value value %}</td></tr>
                    {% endfor %}
                </table>
            </div>
        </div>


    <!-- Publication status -->
    <div class="panel panel-default">
        <div class='panel-heading'>
            <div class='panel-title'>
                <a data-toggle='collapse' href='#pubStatus'>{% trans "Publication Status" %}</a>
            </div>
        </div>

        <div id="pubStatus" class="panel-collapse collapse">
            <table class='table table-condensed'>
                <tr><th>{% trans "Creation Date" %}</th><td>{{gloss.creationDate}}</td></tr>
                <tr><th>{% trans "Creator" %}</th>
                    <td>{% for creator in gloss.creator.all %}
                            {% if forloop.last %}
                                {{creator.first_name}} {{creator.last_name}}
                            {% else %}
                                {{creator.first_name}} {{creator.last_name}},
                            {% endif %}
                        {% endfor %}
                    </td>
                </tr>

                {%if SHOW_DATASET_INTERFACE_OPTIONS %}
                <tr><th>{% trans "Dataset" %}</th><td id='dataset' colspan="2">{{ gloss.lemma.dataset }}</td></tr>
                {% endif %}

                {% for value,name,label,kind in publication_fields %}
	            <tr {% if value == None or value == False %} class="empty_row" {% endif %}>
                      <th>{{label}}</th>
                      <td class="edit edit_{{kind}}" id='{{name}}'
                          value='{{value}}'>{% if value %}{% trans "Yes" %}{% else %}{% trans "No" %}{% endif %}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>


    <!-- Notes -->
    <div class="panel panel-default">
        <div class='panel-heading'>
            <div class='panel-title'>
                <a data-toggle='collapse' href='#definitions'>{% trans "Notes" %}</a>
                {% if notes_groupedby_role.items %}
                <div class="pull-right">
                <span id="document-icon"><img id='document' src='{{ STATIC_URL }}images/document_with_text_and_picture.png' style="width:30px; height:auto; margin: 0px;"></span>
                </div>
                {% endif %}
            </div>
        </div>
        <div id='definitions' class='collapse'>

            <table class='table'>
              <tr>
                  <th style='width:1em'></th>
                  <th style='width:3em'>{% trans "Published" %}</th>
                  <th style='width:3em'>{% trans "Index" %}</th>
                  <th style='width:10em'>{% trans "Type" %}</th>
                  <th>{% trans "Text" %}</th>
              </tr>
            {% for role_id, note_list in notes_groupedby_role.items %}

              {% for def in note_list %}
              <tr>
                <td>

                   {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
                   {% if "change_dataset" in dataset_perms %}
                    {% if not def.published and perms.dictionary.can_delete_unpublished or def.published and perms.dictionary.can_delete_published %}
                    <span class='glyphicon glyphicon-trash definition_delete' data-toggle='modal' data-target='#delete_definition_modal_{{def.id}}'></span>

                     <div class="modal fade" id="delete_definition_modal_{{def.id}}" role="dialog" aria-labelledby="#modalTitleNote" aria-hidden="true">
                         <div class="modal-dialog modal-sm">
                            <div class="modal-content">
                                <div class='modal-header'>
                                    <h2 id='modalTitleNote'>{% trans "Delete This Note" %}</h2>
                                </div>
                                <div class='modal-body'>
                                    <p><strong>{{role_id.1}}</strong> {{def.text}}</p>
                                    <p>{% trans "This action will delete this note. It cannot be undone." %}</p>
                                 </div>
                              <form action='{% url "dictionary:update_gloss" gloss.id %}' method='post'>
                                  {% csrf_token %}
                                  <input type='hidden' name='id' value='definitiondelete_{{def.id}}'>
                                  <input type='hidden' name='value' value='{% trans "confirmed" %}'>
                                  <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
                                    <input type="submit" class="btn btn-primary" value='{% trans "Confirm Delete" %}'>
                                  </div>
                              </form>

                            </div>
                          </div>
                     </div>
                    {% endif %}
                    {% endif %}
                </td>
                <td {% if perms.dictionary.can_publish %}class='edit edit_check'{% endif %} id='definitionpub_{{def.id}}'
                    value='{{def.published}}'>{% if def.published %}{% trans "Yes" %}{% else %}{% trans "No" %}{% endif %}</td>
                <td class='edit edit_int' id='definitioncount_{{def.id}}'>{{def.count}}</td>
                <td class='edit edit_role' id='definitionrole_{{def.id}}'>{{role_id.1}}</td>
                <td class='edit edit_area' id='definition_{{def.id}}'>{{def.text}}</td>
              </tr>
              {% endfor %}


            {% endfor %}
            </table>

           {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
           {% if "change_dataset" in dataset_perms %}
            <form id='add_definition' action='{% url "dictionary:add_definition" gloss.id %}' method="POST">
                <fieldset>
                {% csrf_token %}
                 <table class='table'>
                    <tr>
                        <td style="width:2em"></td>
                        <td style="width:7em"><input class='checkbox' name='published' id='id_published' type='checkbox'></td>
                        <td style='width:5em'><input class='form-control' name='count' id='id_count' type='number' value=3></td>
                        <td style='width:10em'>{{definitionform.note}}</td>
                        <td><input class='form-control' name='text' id='id_text' placeholder='{% trans "Enter new note" %}'></td>
                    </tr>
                     <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td><input class='btn btn-primary' type='submit' value='{% trans "Save new note" %}'></td>
                    </tr>
                 </table>
            </fieldset>

            </form>
            {% endif %}


        </div>

    </div>

     <!-- Other media -->
    <div class="panel panel-default">
        <div class='panel-heading'>
            <div class='panel-title'>
                <a data-toggle='collapse' href='#othermedia'>{% trans "Other media" %}</a>
                {% if other_media %}
                <div class="pull-right">
                <span id="camera-icon"><img id='camera' src='{{ STATIC_URL }}images/camera.png' style="width:25px; height:25px; margin: 0px;"></span>
                </div>
                {% endif %}
            </div>
        </div>
        <div id='othermedia' class='collapse'>

           <table class='table table-condensed'>
              <tr>
                  <th style='width:2em'></th>
                  <th style='width:12em'>{% trans "Image/Video" %}</th>
                  <th style='width:12em'>{% trans "File Type" %}</th>
                  <th style='width:12em'>{% trans "Type" %}</th>
                  <th style='width:12em'>{% trans "Alternative gloss" %}</th>
              </tr>

               {% for pk,path,file_type,type,alternative_gloss,file_name in other_media %}
               <tr>
                   {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
                   {% if "change_dataset" in dataset_perms %}
                     <td>
                        <span class='glyphicon glyphicon-trash other-video-delete' data-toggle='modal' data-target='#delete_other_media_{{pk}}'></span>

                         <div class="modal fade" id="delete_other_media_{{pk}}" role="dialog" aria-labelledby="#modalTitleMedia" aria-hidden="true">
                             <div class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <div class='modal-header'>
                                        <h2 id='modalTitleMedia'>{% trans "Delete This Media" %}</h2>
                                    </div>
                                    <div class='modal-body'>

                                        <p>{% trans "Are you sure you want to delete this? This cannot be undone." %}</p>
                                     </div>
                                  <form action='{% url "dictionary:update_gloss" gloss.id %}' method='post'>
                                      {% csrf_token %}
                                      <input type='hidden' name='id' value='other-media-delete_{{pk}}'>
                                      <input type='hidden' name='value' value='confirmed'>
                                      <div class="modal-footer">
                                        <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
                                        <input type="submit" class="btn btn-primary" value='{% trans "Confirm Delete" %}'>
                                      </div>
                                  </form>

                                </div>
                              </div>
                         </div>

                    </td>
                    {% else %}
                    <td></td>
                    {% endif %}
                    <td><a download="{{ file_name }}" href="{{ URL }}{{ PREFIX_URL }}{{ path }}">Download</a></td>
                    <td id='other-media-file-type_{{ pk }}'>{{ file_type }}</td>
                    <td class='edit edit_list' id='other-media-type_{{ pk }}'>{{ type }}</td>
                    <td class='edit edit_text' id='other-media-alternative-gloss_{{ pk }}'>{{ alternative_gloss }}</td>
                </tr>
               {% endfor %}

           </table>

           {% get_obj_perms request.user for gloss.lemma.dataset as "dataset_perms" %}
           {% if "change_dataset" in dataset_perms %}
            <form id='add_other_media' action='{% url "dictionary:add_othermedia" %}' method="POST" enctype="multipart/form-data">

               <input type='hidden' name='gloss' value='{{gloss.pk}}'>

                <fieldset>
                {% csrf_token %}
                 <table class='table'>
                    <tr>
                        <td><input class='form-control' placeholder='{% trans "Upload media" %}' name='file' type='file'></td>
                        <td>{{othermediaform.type}}</td>
                        <td><input class='form-control' placeholder='{% trans "Alternative gloss" %}' name='alternative_gloss' type='text'></td>
                    </tr>
                     <tr>
                        <td></td>
                        <td></td>
                        <td><input class='btn btn-primary' type='submit' value='{% trans "Save" %}'></td>
                    </tr>
                 </table>
            </fieldset>

            </form>
            {% endif %}

        </div>
    </div>

    </div>
</div>


{% endblock %}
